#!/usr/bin/env node

/**
 * Module dependencies.
 */

var app = require('../app');
var debug = require('debug')('backend:server');
var http = require('http');
const { Server } = require('socket.io'); // üî• AJOUT

/**
 * Get port from environment and store in Express.
 */

var port = normalizePort(process.env.PORT || '3000');
app.set('port', port);

/**
 * Create HTTP server.
 */

var server = http.createServer(app);

/**
 * üî• NOUVEAU : Initialiser Socket.IO
 */
const io = new Server(server, {
  cors: {
    origin: "https://lively-marin-savepantry-9e49e14e.koyeb.app/", // √Ä adapter selon ton front-end pour une version web de save pantry
    methods: ["GET", "POST"]
  }
});

//    1) On attache l'instance io √† Express via app.set('io')
//    ‚Üí Cela permet d'acc√©der √† io depuis n'importe quelle route (ex : pour 
//      √©mettre un √©v√©nement "list-updated" apr√®s une modification en base).
app.set('io', io);

//    2) io.on('connection', ...) est ex√©cut√© √† chaque nouvelle connexion client.
//    ‚Üí Chaque utilisateur obtient un socket.id unique.
io.on('connection', (socket) => {
  console.log('‚úÖ Utilisateur connect√©:', socket.id);

 // 3) join-list(listId)
//    ‚Üí Le client rejoint une "room" sp√©cifique √† une liste partag√©e.
//    ‚Üí Ainsi, seuls les utilisateurs concern√©s re√ßoivent les mises √† jour.
  socket.on('join-list', (listId) => {
    socket.join(`list-${listId}`);
    console.log(`Socket ${socket.id} a rejoint la liste ${listId}`);
  });
// 4) leave-list(listId)
//    ‚Üí Le client quitte la room lorsqu'il n'affiche plus la liste.
  socket.on('leave-list', (listId) => {
    socket.leave(`list-${listId}`);
    console.log(`Socket ${socket.id} a quitt√© la liste ${listId}`);
  });
// 5) disconnect
//    ‚Üí Permet de log ou nettoyer si besoin.
  socket.on('disconnect', () => {
    console.log('‚ùå Utilisateur d√©connect√©:', socket.id);
  });
});

// R√©sultat :
// Chaque liste partag√©e poss√®de son propre canal temps r√©el ("list-<id>").
// D√®s qu'une liste est modifi√©e, seule la room correspondante re√ßoit
// l'√©v√©nement "list-updated", ce qui √©vite de notifier tous les utilisateurs.
//
// C'est le c≈ìur de la synchronisation en temps r√©el du shopping list.

/**
 * Listen on provided port, on all network interfaces.
 */

server.listen(port);
server.on('error', onError);
server.on('listening', onListening);

/**
 * Normalize a port into a number, string, or false.
 */

function normalizePort(val) {
  var port = parseInt(val, 10);

  if (isNaN(port)) {
    // named pipe
    return val;
  }

  if (port >= 0) {
    // port number
    return port;
  }

  return false;
}

/**
 * Event listener for HTTP server "error" event.
 */

function onError(error) {
  if (error.syscall !== 'listen') {
    throw error;
  }

  var bind = typeof port === 'string'
    ? 'Pipe ' + port
    : 'Port ' + port;

  // handle specific listen errors with friendly messages
  switch (error.code) {
    case 'EACCES':
      console.error(bind + ' requires elevated privileges');
      process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(bind + ' is already in use');
      process.exit(1);
      break;
    default:
      throw error;
  }
}

/**
 * Event listener for HTTP server "listening" event.
 */

function onListening() {
  var addr = server.address();
  var bind = typeof addr === 'string'
    ? 'pipe ' + addr
    : 'port ' + addr.port;
  debug('Listening on ' + bind);
  console.log('üöÄ Serveur d√©marr√© sur le port', port);
}